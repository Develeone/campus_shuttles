<html>
<head>

<title>Карта шаттлов Кампуса ДВФУ</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#6495ed">
<meta name="theme-color" content="#6495ed">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<link rel="stylesheet" href="leaflet.css"/>
<script src="leaflet.js"></script>

<style>
	* {
		margin: 0;
		padding: 0;
	}

	.buses-map {
		width:100%;
		height: 100%;
	}
</style>

<script>
var markers = [];
var markersActualPosition = [];

$(document).ready( function(page) {
    markers = [];
    markersActualPosition = [];

    var map = L.map('buses-map').setView([43.028306, 131.89456], 14);

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '',
        maxZoom: 18
    }).addTo(map);

    var busIcon = L.icon({
        iconUrl: 'bus_marker.png',
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [-3, -76]
    });

    var lerpingInterval = setInterval(
        function () {
            for (var key in markers) {
                var currentLatLng = markers[key].getLatLng();
                var currentRotation = markers[key].getRotation();

                var targetPosition = markersActualPosition[key];

                if (!targetPosition)
                    return;

                markers[key].setLatLng([lerp(currentLatLng.lat, targetPosition.lat),
                                        lerp(currentLatLng.lng, targetPosition.lng)]);

                markers[key].setRotation(lerp(currentRotation, targetPosition.bearing));
            }
        },
        50
    );

    function lerp(from, to) {
        return from+((to-from)/20);
    }

    updateBuses();

    function updateBuses() {
        $.get(
            "http://inf.awake.su/buses",
            function (buses) {
                JSON.parse(buses).forEach(function (bus) {
                    if (bus.age < 90000)
                        if (!markers[bus.udid]) {
                            markers[bus.udid] = L.marker([bus.lat, bus.lon], {icon: busIcon});
                            markers[bus.udid].addTo(map);
                            markers[bus.udid].setRotation(bus.bearing);
                        } else {
                            var bearing = bus.bearing;

                            if (markersActualPosition[bus.udid])
                                bearing = bearing || markersActualPosition[bus.udid].bearing;

                            markersActualPosition[bus.udid] = {lat: bus.lat, lng: bus.lon, bearing: bearing};
                        }
                });

                setTimeout(updateBuses, 1000);
            }
        );
    }
});

</script>

</head>
<body>

<div id="buses-map" style="width:100%; height: 100%;"></div>

</body>
</html>
